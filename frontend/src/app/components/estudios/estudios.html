<div class="estudios-container">
  <div class="header-section">
    <h1>Gestión de Estudios</h1>
    <button mat-raised-button color="primary" (click)="openAddDialog()" class="add-button">
      <mat-icon>add</mat-icon>
      Nuevo Estudio
    </button>
  </div>

  <!-- Dashboard Stats -->
  <div class="stats-section">
    <div class="stats-grid">
      <mat-card class="stat-card total">
        <mat-card-content>
          <div class="stat-content">
            <mat-icon>assignment</mat-icon>
            <div class="stat-info">
              <span class="number">{{ getEstudiosStats().total }}</span>
              <span class="label">Total Estudios</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card programados">
        <mat-card-content>
          <div class="stat-content">
            <mat-icon>schedule</mat-icon>
            <div class="stat-info">
              <span class="number">{{ getEstudiosStats().programados }}</span>
              <span class="label">Programados</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card en-proceso">
        <mat-card-content>
          <div class="stat-content">
            <mat-icon>hourglass_empty</mat-icon>
            <div class="stat-info">
              <span class="number">{{ getEstudiosStats().enProceso }}</span>
              <span class="label">En Proceso</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card completados">
        <mat-card-content>
          <div class="stat-content">
            <mat-icon>check_circle</mat-icon>
            <div class="stat-info">
              <span class="number">{{ getEstudiosStats().completados }}</span>
              <span class="label">Completados</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card urgentes" *ngIf="getEstudiosStats().urgentes > 0">
        <mat-card-content>
          <div class="stat-content">
            <mat-icon>priority_high</mat-icon>
            <div class="stat-info">
              <span class="number">{{ getEstudiosStats().urgentes }}</span>
              <span class="label">Urgentes</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Filters Section (ÚNICA BARRA DE FILTROS) -->
  <div class="filters-section">
    <div class="search-filters">
      <mat-form-field appearance="fill" class="search-field">
        <mat-label>Buscar estudios</mat-label>
        <input
          matInput
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
          placeholder="Paciente, tipo de estudio, parte del cuerpo..."
        />
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-field">
        <mat-label>Estado</mat-label>
        <mat-select [(value)]="selectedEstado" (selectionChange)="onEstadoChange()">
          <mat-option *ngFor="let estado of estadoOptions" [value]="estado">
            {{ estado }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-field">
        <mat-label>Modalidad</mat-label>
        <mat-select [(value)]="selectedModalidad" (selectionChange)="onModalidadChange()">
          <mat-option *ngFor="let modalidad of modalidadOptions" [value]="modalidad">
            {{ modalidad === 'Todos' ? modalidad : getModalidadName(modalidad) }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-field">
        <mat-label>Urgencia</mat-label>
        <mat-select [(value)]="selectedUrgencia" (selectionChange)="onUrgenciaChange()">
          <mat-option *ngFor="let urgencia of urgenciaOptions" [value]="urgencia">
            {{ urgencia }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Selector de Fecha -->
      <mat-form-field appearance="fill" class="filter-field date-picker">
        <mat-label>Fecha</mat-label>
        <input 
          matInput 
          [matDatepicker]="picker" 
          [(ngModel)]="selectedDate"
          (dateChange)="onDateChange()"
          placeholder="DD/MM/YYYY"
        />
        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
      </mat-form-field>

      <!-- Botón Exportar CSV -->
      <button mat-stroked-button (click)="exportToCSV()" class="export-button">
        <mat-icon>download</mat-icon>
        Exportar CSV
      </button>
    </div>
  </div>

  <!-- Content Section -->
  <div class="content-section" *ngIf="!isLoading; else loadingTemplate">
    <div *ngIf="filteredEstudios.length === 0; else estudiosTemplate" class="no-data">
      <mat-icon>science</mat-icon>
      <h3>
        {{ searchTerm || selectedEstado !== 'Todos' || selectedModalidad !== 'Todos' ||
        selectedUrgencia !== 'Todos' ? 'No se encontraron estudios' : 'No hay estudios registrados'
        }}
      </h3>
      <p>
        {{ searchTerm || selectedEstado !== 'Todos' || selectedModalidad !== 'Todos' ||
        selectedUrgencia !== 'Todos' ? 'Intenta ajustar los filtros' : 'Comienza creando tu primer
        estudio' }}
      </p>
    </div>

    <ng-template #estudiosTemplate>
      <!-- Vista de Lista -->
      <div class="list-container">
        <div 
          *ngFor="let estudio of filteredEstudios" 
          class="estudio-list-item"
          [class.urgent]="estudio.urgente"
          [class.expanded]="expandedEstudioId === estudio.id"
        >
          <!-- Fila compacta -->
          <div class="list-item-row" (click)="toggleExpand(estudio.id)">
            <div class="item-icon">
              <mat-icon [class.urgent-icon]="estudio.urgente">
                {{ estudio.urgente ? 'priority_high' : 'assignment' }}
              </mat-icon>
            </div>
            
            <div class="item-patient">
              <span class="patient-name">{{ estudio.paciente_nombre }}</span>
              <mat-chip [class]="getEstadoClass(estudio.estado)" class="status-chip">
                {{ estudio.estado }}
              </mat-chip>
            </div>

            <div class="item-study">
              <span class="study-type">{{ estudio.tipo_estudio }}</span>
            </div>

            <div class="item-date">
              <mat-icon>event</mat-icon>
              <span>{{ estudio.fecha_realizacion | date:'dd/MM/yyyy' }}</span>
            </div>

            <div class="item-modality">
              <mat-icon>{{ getModalidadIcon(estudio.modalidad) }}</mat-icon>
              <span>{{ getModalidadName(estudio.modalidad) }}</span>
            </div>

            <div class="item-actions">
              <button 
                mat-icon-button 
                class="expand-button"
                (click)="toggleExpand(estudio.id); $event.stopPropagation()"
              >
                <mat-icon>{{ expandedEstudioId === estudio.id ? 'expand_less' : 'expand_more' }}</mat-icon>
              </button>
            </div>
          </div>

          <!-- Tarjeta expandible con detalles -->
          <div class="expanded-details" *ngIf="expandedEstudioId === estudio.id">
            <mat-card class="detail-card">
              <mat-card-content>
                <div class="details-grid">
                  <div class="detail-section">
                    <h4><mat-icon>person</mat-icon> Información del Paciente</h4>
                    <div class="detail-row">
                      <span class="label">Nombre:</span>
                      <span class="value">{{ estudio.paciente_nombre }}</span>
                    </div>
                  </div>

                  <div class="detail-section">
                    <h4><mat-icon>medical_services</mat-icon> Detalles del Estudio</h4>
                    <div class="detail-row">
                      <span class="label">Tipo de Estudio:</span>
                      <span class="value">{{ estudio.tipo_estudio }}</span>
                    </div>
                    <div class="detail-row">
                      <span class="label">Modalidad:</span>
                      <span class="value">{{ getModalidadName(estudio.modalidad) }}</span>
                    </div>
                    <div class="detail-row">
                      <span class="label">Parte del Cuerpo:</span>
                      <span class="value">{{ estudio.parte_cuerpo }}</span>
                    </div>
                    <div class="detail-row" *ngIf="estudio.contraste">
                      <span class="label">Contraste:</span>
                      <span class="value contrast-badge">
                        <mat-icon>opacity</mat-icon> Requerido
                      </span>
                    </div>
                  </div>

                  <div class="detail-section">
                    <h4><mat-icon>schedule</mat-icon> Fechas e Historia</h4>
                    <div class="detail-row">
                      <span class="label">Fecha de Realización:</span>
                      <span class="value">{{ estudio.fecha_realizacion | date:'dd/MM/yyyy HH:mm' }}</span>
                    </div>
                    <div class="detail-row">
                      <span class="label">Estado:</span>
                      <span class="value">
                        <mat-chip [class]="getEstadoClass(estudio.estado)">
                          {{ estudio.estado }}
                        </mat-chip>
                      </span>
                    </div>
                    <div class="detail-row" *ngIf="estudio.urgente">
                      <span class="label">Prioridad:</span>
                      <span class="value urgent-badge">
                        <mat-icon>priority_high</mat-icon> URGENTE
                      </span>
                    </div>
                  </div>

                  <div class="detail-section" *ngIf="estudio.medico_referente">
                    <h4><mat-icon>local_hospital</mat-icon> Médico Referente</h4>
                    <div class="detail-row">
                      <span class="label">Doctor:</span>
                      <span class="value">{{ estudio.medico_referente }}</span>
                    </div>
                  </div>

                  <div class="detail-section full-width" *ngIf="estudio.observaciones">
                    <h4><mat-icon>notes</mat-icon> Observaciones</h4>
                    <div class="detail-row">
                      <p class="observations">{{ estudio.observaciones }}</p>
                    </div>
                  </div>
                </div>

                <div class="card-actions">
                  <button mat-raised-button color="primary" (click)="openEditDialog(estudio)">
                    <mat-icon>edit</mat-icon>
                    Editar
                  </button>
                  <button mat-raised-button color="warn" (click)="deleteEstudio(estudio)">
                    <mat-icon>delete</mat-icon>
                    Eliminar
                  </button>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      </div>
    </ng-template>
  </div>

  <ng-template #loadingTemplate>
    <div class="loading-container">
      <mat-icon class="loading-spinner">hourglass_empty</mat-icon>
      <p>Cargando estudios...</p>
    </div>
  </ng-template>
</div>